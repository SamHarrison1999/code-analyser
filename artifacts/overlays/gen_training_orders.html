<!doctype html><meta charset='utf-8'><title>gen_training_orders – overlay</title><div style='max-width:980px;margin:24px auto'><h3 style='font-family:Inter,system-ui'>File: gen_training_orders</h3><div><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>sast_risk: 0.40</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>ml_signal: 0.50</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>best_practice: 0.59</span></div><pre style='background:#0b1021;color:#ebedf5;padding:12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.4'># Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

import os
import numpy as np
import pandas as pd

from pathlib import Path

DATA_PATH = Path(os.path.join("data", "pickle", "backtest"))
OUTPUT_PATH = Path(os.path.join("data", "orders"))


def generate_order(stock: str, start_idx: int, end_idx: int) -&gt; bool:
    dataset = pd.read_pickle(DATA_PATH / f"{stock}.pkl")
    df = dataset.handler.fetch(level=None).reset_index()
    if len(df) == 0 or df.isnull().values.any() or min(df["$volume0"]) &lt; 1e-5:
        return False

    df["date"] = df["datetime"].dt.date.astype("datetime64")
    df = df.set_index(["instrument", "datetime", "date"])
    df = (
        df.groupby("date", group_keys=False)
        .take(range(start_idx, end_idx))
        .droplevel(level=0)
    )

    order_all = pd.DataFrame(df.groupby(level=(2, 0), group_keys=False).mean().dropna())
    order_all["amount"] = np.random.lognormal(-3.28, 1.14) * order_all["$volume0"]
    order_all = order_all[order_all["amount"] &gt; 0.0]
    order_all["order_type"] = 0
    order_all = order_all.drop(columns=["$volume0"])

    order_train = order_all[
        order_all.index.get_level_values(0) &lt;= pd.Timestamp("2021-06-30")
    ]
    order_test = order_all[
        order_all.index.get_level_values(0) &gt; pd.Timestamp("2021-06-30")
    ]
    order_valid = order_test[
        order_test.index.get_level_values(0) &lt;= pd.Timestamp("2021-09-30")
    ]
    order_test = order_test[
        order_test.index.get_level_values(0) &gt; pd.Timestamp("2021-09-30")
    ]

    for order, tag in zip(
        (order_train, order_valid, order_test, order_all),
        ("train", "valid", "test", "all"),
    ):
        path = OUTPUT_PATH / tag
        os.makedirs(path, exist_ok=True)
        if len(order) &gt; 0:
            order.to_pickle(path / f"{stock}.pkl.target")
    return True


np.random.seed(1234)
file_list = sorted(os.listdir(DATA_PATH))
stocks = [f.replace(".pkl", "") for f in file_list]
np.random.shuffle(stocks)

cnt = 0
for stock in stocks:
    if generate_order(stock, 0, 240 // 5 - 1):
        cnt += 1
        if cnt == 100:
            break
</pre><div style='color:#666;font-size:12px'>Threshold 0.30. Ticks on dashboard indicate predictions ≥ threshold.</div></div>
