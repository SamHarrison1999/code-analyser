<!doctype html><meta charset='utf-8'><title>eastmoney_block_meta_recorder – overlay</title><div style='max-width:980px;margin:24px auto'><h3 style='font-family:Inter,system-ui'>File: eastmoney_block_meta_recorder</h3><div><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>sast_risk: 0.55</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>ml_signal: 0.45</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>best_practice: 0.60</span></div><pre style='background:#0b1021;color:#ebedf5;padding:12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.4'># -*- coding: utf-8 -*-
import pandas as pd
import requests

from zvt.api.utils import china_stock_code_to_id
from zvt.contract.api import df_to_db
from zvt.contract.recorder import Recorder, TimeSeriesDataRecorder
from zvt.domain import BlockStock, BlockCategory, Block
from zvt.recorders.consts import DEFAULT_HEADER
from zvt.utils.time_utils import now_pd_timestamp
from zvt.utils.utils import json_callback_param


class EastmoneyBlockRecorder(Recorder):
    provider = "eastmoney"
    data_schema = Block

    # 用于抓取行业/概念/地域列表
    category_map_url = {
        BlockCategory.industry: "https://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&amp;cmd=C._BKHY&amp;sty=DCRRBKCPAL&amp;st=(ChangePercent)&amp;sr=-1&amp;p=1&amp;ps=200&amp;lvl=&amp;cb=jsonp_F1A61014DE5E45B7A50068EA290BC918&amp;token=4f1862fc3b5e77c150a2b985b12db0fd&amp;_=08766",
        BlockCategory.concept: "https://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&amp;cmd=C._BKGN&amp;sty=DCRRBKCPAL&amp;st=(ChangePercent)&amp;sr=-1&amp;p=1&amp;ps=300&amp;lvl=&amp;cb=jsonp_3071689CC1E6486A80027D69E8B33F26&amp;token=4f1862fc3b5e77c150a2b985b12db0fd&amp;_=08251",
        # BlockCategory.area: 'https://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&amp;cmd=C._BKDY&amp;sty=DCRRBKCPAL&amp;st=(ChangePercent)&amp;sr=-1&amp;p=1&amp;ps=200&amp;lvl=&amp;cb=jsonp_A597D4867B3D4659A203AADE5B3B3AD5&amp;token=4f1862fc3b5e77c150a2b985b12db0fd&amp;_=02443'
    }

    def run(self):
        for category, url in self.category_map_url.items():
            resp = requests.get(url, headers=DEFAULT_HEADER)
            results = json_callback_param(resp.text)
            the_list = []
            for result in results:
                items = result.split(",")
                code = items[1]
                name = items[2]
                entity_id = f"block_cn_{code}"
                the_list.append(
                    {
                        "id": entity_id,
                        "entity_id": entity_id,
                        "entity_type": "block",
                        "exchange": "cn",
                        "code": code,
                        "name": name,
                        "category": category.value,
                    }
                )
            if the_list:
                df = pd.DataFrame.from_records(the_list)
                df_to_db(data_schema=self.data_schema, df=df, provider=self.provider, force_update=self.force_update)
            self.logger.info(f"finish record eastmoney blocks:{category.value}")


class EastmoneyBlockStockRecorder(TimeSeriesDataRecorder):
    entity_provider = "eastmoney"
    entity_schema = Block

    provider = "eastmoney"
    data_schema = BlockStock

    # 用于抓取行业包含的股票
    category_stocks_url = "https://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&amp;cmd=C.{}{}&amp;sty=SFCOO&amp;st=(Close)&amp;sr=-1&amp;p=1&amp;ps=300&amp;cb=jsonp_B66B5BAA1C1B47B5BB9778045845B947&amp;token=7bc05d0d4c3c22ef9fca8c2a912d779c"

    def record(self, entity, start, end, size, timestamps):
        resp = requests.get(self.category_stocks_url.format(entity.code, "1"), headers=DEFAULT_HEADER)
        try:
            results = json_callback_param(resp.text)
            the_list = []
            for result in results:
                items = result.split(",")
                stock_code = items[1]
                stock_id = china_stock_code_to_id(stock_code)
                block_id = entity.id

                the_list.append(
                    {
                        "id": "{}_{}".format(block_id, stock_id),
                        "entity_id": block_id,
                        "entity_type": "block",
                        "exchange": entity.exchange,
                        "code": entity.code,
                        "name": entity.name,
                        "timestamp": now_pd_timestamp(),
                        "stock_id": stock_id,
                        "stock_code": stock_code,
                        "stock_name": items[2],
                    }
                )
            if the_list:
                df = pd.DataFrame.from_records(the_list)
                df_to_db(data_schema=self.data_schema, df=df, provider=self.provider, force_update=True)

            self.logger.info("finish recording block:{},{}".format(entity.category, entity.name))

        except Exception as e:
            self.logger.error("error:,resp.text:", e, resp.text)
        self.sleep()


if __name__ == "__main__":
    # init_log('china_stock_category.log')
    EastmoneyBlockRecorder().run()

    recorder = EastmoneyBlockStockRecorder(code="BK1144")
    recorder.run()


# the __all__ is generated
__all__ = ["EastmoneyBlockRecorder", "EastmoneyBlockStockRecorder"]
</pre><div style='color:#666;font-size:12px'>Threshold 0.50. Ticks on dashboard indicate predictions ≥ threshold.</div></div>