<!doctype html><meta charset='utf-8'><title>sina_block_money_flow_recorder – overlay</title><div style='max-width:980px;margin:24px auto'><h3 style='font-family:Inter,system-ui'>File: sina_block_money_flow_recorder</h3><div><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>sast_risk: 0.55</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>ml_signal: 0.45</span><span style='padding:2px 6px;border-radius:10px;border:1px solid #888;margin-right:6px'>best_practice: 0.61</span></div><pre style='background:#0b1021;color:#ebedf5;padding:12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.4'># -*- coding: utf-8 -*-
import time

import requests

from zvt.contract.recorder import FixedCycleDataRecorder
from zvt.domain import BlockMoneyFlow, BlockCategory, Block
from zvt.utils.time_utils import to_pd_timestamp
from zvt.utils.utils import to_float


# 实时资金流
# 'http://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/MoneyFlow.ssl_bkzj_bk?page=1&amp;num=20&amp;sort=netamount&amp;asc=0&amp;fenlei=1'
# 'http://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/MoneyFlow.ssl_bkzj_bk?page=1&amp;num=20&amp;sort=netamount&amp;asc=0&amp;fenlei=0'


class SinaBlockMoneyFlowRecorder(FixedCycleDataRecorder):
    # entity的信息从哪里来
    entity_provider = "sina"
    # entity的schema
    entity_schema = Block

    # 记录的信息从哪里来
    provider = "sina"
    # 记录的schema
    data_schema = BlockMoneyFlow

    url = "http://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/MoneyFlow.ssl_bkzj_zjlrqs?page=1&amp;num={}&amp;sort=opendate&amp;asc=0&amp;bankuai={}%2F{}"

    def generate_url(self, category, code, number):
        if category == BlockCategory.industry.value:
            block = 0
        elif category == BlockCategory.concept.value:
            block = 1

        return self.url.format(number, block, code)

    def get_data_map(self):
        return {}

    def record(self, entity, start, end, size, timestamps):
        url = self.generate_url(category=entity.category, code=entity.code, number=size)

        resp = requests.get(url)

        opendate = "opendate"
        avg_price = "avg_price"
        avg_changeratio = "avg_changeratio"
        turnover = "turnover"
        netamount = "netamount"
        ratioamount = "ratioamount"
        r0_net = "r0_net"
        r0_ratio = "r0_ratio"
        r0x_ratio = "r0x_ratio"
        cnt_r0x_ratio = "cnt_r0x_ratio"

        json_list = []
        try:
            json_list = eval(resp.text)
        except Exception as e:
            resp.encoding = "GBK"
            self.logger.error(resp.text)
            time.sleep(60 * 5)

        result_list = []
        for item in json_list:
            result_list.append(
                {
                    "name": entity.name,
                    "timestamp": to_pd_timestamp(item["opendate"]),
                    "close": to_float(item["avg_price"]),
                    "change_pct": to_float(item["avg_changeratio"]),
                    "turnover_rate": to_float(item["turnover"]) / 10000,
                    "net_inflows": to_float(item["netamount"]),
                    "net_inflow_rate": to_float(item["ratioamount"]),
                    "net_main_inflows": to_float(item["r0_net"]),
                    "net_main_inflow_rate": to_float(item["r0_ratio"]),
                }
            )

        return result_list


if __name__ == "__main__":
    SinaBlockMoneyFlowRecorder(codes=["new_fjzz"]).run()
    # SinaIndexMoneyFlowRecorder().run()


# the __all__ is generated
__all__ = ["SinaBlockMoneyFlowRecorder"]
</pre><div style='color:#666;font-size:12px'>Threshold 0.50. Ticks on dashboard indicate predictions ≥ threshold.</div></div>