# Annotation: Give the workflow a friendly name with an emoji.
name: ðŸ§ª CI Pipeline
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  test:
    # Annotation: Human-readable job name.
    name: ðŸ” Run Linters and test
    runs-on: ubuntu-latest
    env:
      # Annotation: Ensure local src/ is on the import path during tests.
      PYTHONPATH: src
    steps:
      # Annotation: Checkout the repository code.
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      # Annotation: Set up the requested Python version.
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      # Annotation: Cache pip downloads to speed up subsequent runs.
      - name: ðŸ’¾ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      # Annotation: Install a couple of light system packages used by tests and tools.
      - name: ðŸ› ï¸ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk xvfb cloc
      # Annotation: Install Python dependencies (editable project + extras and tooling).
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[gui,test]
          pip install pytest requests ruff black bandit
      # Annotation: Run Ruff with an explicit target-version to avoid py38-only syntax checks.
      - name: ðŸ§¹ Run ruff linter (excluding datasets/)
        run: ruff check . --exclude datasets --target-version py312
      # Annotation: Run Black in check mode; the simple pattern excludes datasets/.
      - name: ðŸŽ¨ Run black (check mode, excluding datasets/)
        run: black --check . --exclude datasets
      # Annotation: Run Bandit for a quick security lint (non-fatal).
      - name: ðŸ”’ Run bandit (non-blocking)
        continue-on-error: true
        run: bandit -r src -x datasets || true
      # Annotation: Run test suite under a virtual framebuffer; 'pipefail' preserves pytestâ€™s exit code when using tee.
      - name: ðŸ§ª Run tests
        shell: bash
        run: |
          set -euxo pipefail
          xvfb-run -a pytest -q -vv tests 2>&1 | tee last_run.log
      # Annotation: Always upload the test log to help with debugging failures.
      - name: ðŸ“¤ Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: last_run.log
          path: last_run.log
